<div class="comment-layout" [class.is-reply-node]="isReply" [style.--depth]="depth">
  <div class="avatar-column">
    <img [src]="avatarUrl"
         [class.mini-avatar]="!isReply"
         [class.reply-avatar]="isReply" alt="avatar">
  </div>
  <div class="content-column">
    <div class="comment-bubble">
      <div class="comment-header">
        <span class="author-name">{{ comment.username }}</span>
        <span class="dot-separator">•</span>
        <span class="timestamp">{{ comment.dateCreated | date:'yyyy.MM.dd HH:mm' }}</span>
      </div>
      <div class="comment-body">
        @if (!isEditing) {
          <p>{{ comment.content }}</p>
        } @else {
          <div class="edit-container">
            <div class="edit-input-wrapper">
        <textarea
          class="reply-textarea edit-textarea"
          [(ngModel)]="editText"
          (input)="autoResize($event)"
          rows="1"
          placeholder="Módosítsd a hozzászólásod..."
          autofocus></textarea>
            </div>
            <div class="edit-actions">
              <button class="edit-btn cancel" (click)="cancelEdit()">Mégse</button>
              <button class="edit-btn save" (click)="saveEdit()" [disabled]="!editText.trim()">
                Mentés
              </button>
            </div>
          </div>
        }
      </div>
    </div>

    <div class="comment-footer">
      <div class="vote-group">
        <button mat-icon-button class="vote-btn"><mat-icon>arrow_upward</mat-icon></button>
        <span class="score">{{ (comment.upVotes || 0) - (comment.downVotes || 0) }}</span>
        <button mat-icon-button class="vote-btn"><mat-icon>arrow_downward</mat-icon></button>
      </div>

      @if(!isOnProfileSite) {
        <div class="footer-action" (click)="toggleReplyForm()">
          <mat-icon>chat_bubble_outline</mat-icon>
          <span>Válasz</span>
        </div>
      }

      @if(isMyComment(comment.username)) {
        <button mat-icon-button [matMenuTriggerFor]="commentMenu" class="mini-menu-btn">
          <mat-icon>more_horiz</mat-icon>
        </button>
      }
    </div>

    <mat-menu #commentMenu="matMenu" class="header-menu comment-menu-panel">
      <button mat-menu-item class="header-menu-item" (click)="editComment()">
        <mat-icon>edit</mat-icon>
        <span>Szerkesztés</span>
      </button>

      <button mat-menu-item class="header-menu-item" (click)="deleteComment(comment.id!)">
        <mat-icon color="warn">delete_outline</mat-icon>
        <span class="warn-text">Törlés</span>
      </button>
    </mat-menu>

    @if(replyFormVisible) {
      <div class="reply-form-container">
        <img [src]="avatarReplierUrl" class="form-avatar" alt="avatar">
        <div class="reply-input-wrapper">
      <textarea
        class="reply-textarea"
        [(ngModel)]="replyText"
        placeholder="Írj választ..."
        rows="1"
        (input)="autoResize($event)"></textarea>
          <div class="reply-form-actions">
            <button class="cancel-btn" (click)="toggleReplyForm()">Mégse</button>
            <button class="submit-btn" (click)="submitReply()" [disabled]="!replyText.trim()">
              <mat-icon>send</mat-icon>
            </button>
          </div>
        </div>
      </div>
    }

    @if(comment.replyCount) {
      <mat-expansion-panel (opened)="loadReplies()" class="replies-panel mat-elevation-z0 desktop-only">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>add_circle_outline</mat-icon>
            {{comment.replyCount}} válasz megjelenítése
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="nested-replies">
          @for (reply of comment.replies; track reply) {
            <app-comment-item
              [comment]="reply"
              [isReply]="true"
              [depth]="(depth || 0) + 1"
              (commentDeleted)="loadReplies()"/> }
        </div>
      </mat-expansion-panel>

      <div class="mobile-replies mobile-only">
        <button class="show-replies-btn" (click)="loadReplies(); repliesVisible = !repliesVisible">
          <mat-icon>{{ repliesVisible ? 'expand_less' : 'expand_more' }}</mat-icon>
          {{ repliesVisible ? 'Válaszok elrejtése' : comment.replyCount + ' válasz' }}
        </button>

        @if(repliesVisible) {
          <<div class="mobile-reply-list">
            @for (reply of comment.replies; track reply) {
              <app-comment-item
                [comment]="reply"
                [isReply]="true"
                [depth]="(depth || 0) + 1"
                (commentDeleted)="loadReplies()" /> }
          </div>
        }
      </div>
    }
  </div>
</div>
